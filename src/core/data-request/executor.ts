/**
 * DataRequest Executor
 * Handles the execution and result processing of DataRequests on the SEDA network
 */

import { postAndAwaitDataRequest, Signer } from '@seda-protocol/dev-tools';
import type { PostDataRequestInput, GasOptions } from '@seda-protocol/dev-tools';
import type { DataRequestResult, NetworkConfig } from '../../types';
import type { ILoggingService } from '../../services';
import { hexBEToNumber } from '../../helpers/hex-converter';

/**
 * Execute a DataRequest on the SEDA network and await its completion
 * @param signer The SEDA signer instance for transaction signing
 * @param postInput The PostDataRequestInput containing oracle program parameters
 * @param gasOptions Gas configuration for the transaction
 * @param awaitOptions Timeout and polling configuration for result monitoring
 * @param networkConfig Network configuration for logging and context
 * @param logger Optional logging service for structured output
 * @returns Promise resolving to DataRequestResult with execution details
 * @throws Error if DataRequest execution fails or times out
 */
export async function executeDataRequest(
  signer: Signer, 
  postInput: PostDataRequestInput, 
  gasOptions: GasOptions, 
  awaitOptions: { timeoutSeconds: number; pollingIntervalSeconds: number },
  networkConfig: NetworkConfig,
  logger?: ILoggingService
): Promise<DataRequestResult> {
  
  // Clean, structured configuration display
  if (logger) {
    logger.info('\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
    logger.info('â”‚                        ğŸ“‹ DataRequest Configuration                 â”‚');
    logger.info('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
    logger.info(`â”‚ Oracle Program ID: ${postInput.execProgramId}`);
    logger.info(`â”‚ Replication Factor: ${postInput.replicationFactor || 0}`);
    logger.info(`â”‚ Gas Limit: ${postInput.execGasLimit?.toLocaleString() || 'N/A'}`);
    logger.info(`â”‚ Gas Price: ${(postInput.gasPrice || 0).toString()}`);
    logger.info(`â”‚ Timeout: ${awaitOptions.timeoutSeconds}s`);
    logger.info('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
    
    logger.info('\nğŸš€ Submitting DataRequest to SEDA network...');
  } else {
    console.log('\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
    console.log('â”‚                        ğŸ“‹ DataRequest Configuration                 â”‚');
    console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
    console.log(`â”‚ Oracle Program ID: ${postInput.execProgramId}`);
    console.log(`â”‚ Replication Factor: ${postInput.replicationFactor || 0}`);
    console.log(`â”‚ Gas Limit: ${postInput.execGasLimit?.toLocaleString() || 'N/A'}`);
    console.log(`â”‚ Gas Price: ${(postInput.gasPrice || 0).toString()}`);
    console.log(`â”‚ Timeout: ${awaitOptions.timeoutSeconds}s`);
    console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
    
    console.log('\nğŸš€ Submitting DataRequest to SEDA network...');
  }
  
  // Post the DataRequest and await result using the SEDA dev-tools API
  const result = await postAndAwaitDataRequest(signer, postInput, gasOptions, awaitOptions);
  
  // Clean, structured results display
  if (logger) {
    logger.info('\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
    logger.info('â”‚                         âœ… DataRequest Results                      â”‚');
    logger.info('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
    logger.info(`â”‚ Request ID: ${result.drId}`);
    logger.info(`â”‚ Exit Code: ${result.exitCode}`);
    logger.info(`â”‚ Block Height: ${result.drBlockHeight}`);
    logger.info(`â”‚ Gas Used: ${result.gasUsed}`);
    logger.info(`â”‚ Consensus: ${result.consensus || 'N/A'}`);
    
    // Handle result data display
    if (result.result) {
      logger.info(`â”‚ Result (hex): ${result.result}`);
      
      // Show numeric conversion if it looks like hex
      if (typeof result.result === 'string' && /^(0x)?[0-9a-fA-F]+$/.test(result.result)) {
        try {
          const numericResult = hexBEToNumber(result.result);
          logger.info(`â”‚ Result (number): ${numericResult}`);
        } catch (error) {
          // Silent fail for conversion errors
        }
      }
    } else {
      logger.info(`â”‚ Result: No result data`);
    }
    
    logger.info('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
    if (networkConfig.explorerEndpoint) {
      logger.info(`â”‚ Explorer: ${networkConfig.explorerEndpoint}/data-requests/${result.drId}/${result.drBlockHeight}`);
    } else {
      logger.info(`â”‚ Explorer: N/A`);
    }
    logger.info('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
  } else {
    console.log('\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
    console.log('â”‚                         âœ… DataRequest Results                      â”‚');
    console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
    console.log(`â”‚ Request ID: ${result.drId}`);
    console.log(`â”‚ Exit Code: ${result.exitCode}`);
    console.log(`â”‚ Block Height: ${result.drBlockHeight}`);
    console.log(`â”‚ Gas Used: ${result.gasUsed}`);
    console.log(`â”‚ Consensus: ${result.consensus || 'N/A'}`);
    
    // Handle result data display
    if (result.result) {
      console.log(`â”‚ Result (hex): ${result.result}`);
      
      // Show numeric conversion if it looks like hex
      if (typeof result.result === 'string' && /^(0x)?[0-9a-fA-F]+$/.test(result.result)) {
        try {
          const numericResult = hexBEToNumber(result.result);
          console.log(`â”‚ Result (number): ${numericResult}`);
        } catch (error) {
          // Silent fail for conversion errors
        }
      }
    } else {
      console.log(`â”‚ Result: No result data`);
    }
    
    console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤');
    if (networkConfig.explorerEndpoint) {
      console.log(`â”‚ Explorer: ${networkConfig.explorerEndpoint}/data-requests/${result.drId}/${result.drBlockHeight}`);
    } else {
      console.log(`â”‚ Explorer: N/A`);
    }
    console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
  }
  
  return {
    drId: result.drId,
    exitCode: result.exitCode,
    result: result.result,
    blockHeight: Number(result.blockHeight),
    gasUsed: result.gasUsed.toString()
  };
} 